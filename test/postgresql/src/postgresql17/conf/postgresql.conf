# PostgreSQL 17 configuration for pgexporter testing
# Minimal configuration with key settings for testing

#------------------------------------------------------------------------------
# CONNECTIONS AND AUTHENTICATION
#------------------------------------------------------------------------------

listen_addresses = '*'
port = 5432
max_connections = PG_MAX_CONNECTIONS
unix_socket_directories = '/tmp'
password_encryption = scram-sha-256

#------------------------------------------------------------------------------
# RESOURCE USAGE (except WAL)
#------------------------------------------------------------------------------

shared_buffers = PG_SHARED_BUFFERS
work_mem = PG_WORK_MEM
max_prepared_transactions = 100
dynamic_shared_memory_type = posix
max_worker_processes = 8
max_parallel_workers_per_gather = 2
max_parallel_maintenance_workers = 2
max_parallel_workers = PG_MAX_PARALLEL_WORKERS

#------------------------------------------------------------------------------
# QUERY TUNING
#------------------------------------------------------------------------------

effective_cache_size = PG_EFFECTIVE_CACHE_SIZE

#------------------------------------------------------------------------------
# WRITE-AHEAD LOG
#------------------------------------------------------------------------------

wal_level = replica
fsync = on
synchronous_commit = on
wal_sync_method = fsync
full_page_writes = on
wal_log_hints = on
checkpoint_timeout = 30min
checkpoint_completion_target = 0.9
max_wal_size = PG_MAX_WAL_SIZE
min_wal_size = 80MB

#------------------------------------------------------------------------------
# REPORTING AND LOGGING
#------------------------------------------------------------------------------

log_destination = 'stderr'
logging_collector = on
log_directory = '/pglog'
log_filename = 'logfile'
log_truncate_on_rotation = off
log_rotation_age = 1d
log_rotation_size = 10MB
log_min_messages = PG_LOG_LEVEL
log_min_error_statement = error
log_min_duration_statement = -1
log_checkpoints = on
log_connections = on
log_disconnections = on
log_duration = off
log_line_prefix = '%m [%p] %q%u@%d '
log_lock_waits = on
log_statement = 'none'
log_temp_files = -1
log_timezone = 'UTC'

#------------------------------------------------------------------------------
# AUTOVACUUM
#------------------------------------------------------------------------------

autovacuum = on
autovacuum_max_workers = 3
autovacuum_naptime = 1min

#------------------------------------------------------------------------------
# CLIENT CONNECTION DEFAULTS
#------------------------------------------------------------------------------

datestyle = 'iso, mdy'
timezone = 'UTC'
lc_messages = 'C'
lc_monetary = 'C'
lc_numeric = 'C'
lc_time = 'C'
default_text_search_config = 'pg_catalog.english'

#------------------------------------------------------------------------------
# SHARED LIBRARY PRELOADING
#------------------------------------------------------------------------------

shared_preload_libraries = 'pg_stat_statements'

#------------------------------------------------------------------------------
# STATISTICS
#------------------------------------------------------------------------------

track_activities = on
track_activity_query_size = 1024
track_counts = on
track_io_timing = on
track_wal_io_timing = on
track_functions = all
stats_fetch_consistency = none

# pg_stat_statements
pg_stat_statements.max = 10000
pg_stat_statements.track = all
pg_stat_statements.track_utility = on
pg_stat_statements.track_planning = on
